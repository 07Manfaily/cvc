import React, { useState, useEffect } from "react";
import axios from "axios";
import { useParams } from "react-router-dom";
import { Vortex } from "react-loader-spinner";

import {
  Grid,
  Button,
  TableCell,
  TableBody,
  TextField,
  TableContainer,
  Table,
  Paper,
  TableHead,
  TableRow,
  Modal,
  Backdrop,
  Fade,
  IconButton,
} from "@mui/material";
import { Alert } from "@mui/lab";
import AddBoxIcon from "@mui/icons-material/AddBox";
import DeleteIcon from "@mui/icons-material/Delete";
import EditIcon from "@mui/icons-material/Edit";
import { fNumber } from "app/utils/formatNumber";
import getCookie from "app/utils/getCookies";
import { formatKeyResponseBeforeRequest } from "app/utils/constomizeResponse";

export default function BeforeRequest({ sendValue }) {
  const { Id } = useParams();
  const [data, setData] = useState([]);
  const [open, setOpen] = useState(false);
  const [editRow, setEditRow] = useState(null);
  const [loading, setLoading] = useState(true);
  const [nature, setNature] = useState("");
  const [compte, setCompte] = useState("");
  const [autorisation, setAutorisation] = useState("");
  const [encour, setEncour] = useState("");
  const [devise, setDevise] = useState("");
  const [delais, setDelais] = useState("");

  const style = {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-20%, -50%)",
    width: 700,
    bgcolor: "background.paper",
    border: "2px solid #000",
    boxShadow: 24,
    p: 4,
  };

  const format = formatKeyResponseBeforeRequest;

  const handleModalOpen = () => {
    setEditRow(null);
    setOpen(true);
    setNature("");
    setCompte("");
    setAutorisation("");
    setEncour("");
    setDevise("");
    setDelais("");
  };

  const updateRow = (row) => {
    setEditRow(row);
    setOpen(true);
    setNature(row.title);
    setCompte(row.account_number);
    setAutorisation(row.autorisation_amount);
    setEncour(row.outstanding_amount);
    setDevise(row.devise);
    setDelais(row.maturity_date);
  };

  const deleteRow = (row) => {
    const newData = data.filter((line) => line !== row);
    setData(newData);
    setOpen(false);
  };

  const handleModalClose = () => {
    setOpen(false);
    setEditRow(null);
  };

  const columnTitle = [
    "title",
    "account_number",
    "devise",
    "autorisation_amount",
    "outstanding_amount",
    "maturity_date",
  ];

  const handleValue = async () => {
    try {
      const response = await axios.post(
        "/api/commitment/before_insight",
        { number_client: Id },
        {
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": getCookie("csrf_refresh_token"),
          },
        }
      );

      if (response.status === 200) {
        setLoading(false);
        setData(response.data.data);
      }
    } catch (error) {
      setLoading(false);
      console.log("Error lors du traitement de before inside:", error);
    }
  };

  useEffect(() => {
    if (Id) {
      handleValue();
    }
  }, [Id]);

  const handleSendInsight = async () => {
    try {
      // Transformation des données avant l'envoi à l'API
      const dataToSend = data.map((item) => ({
        line: item.title, // Remplace "title" par "line"
        account_number: item.account_number,
        authorization: item.autorisation_amount, // Remplace "autorisation_amount" par "authorization"
        outstanding_amount: item.outstanding_amount,
        devise: item.devise,
        maturity_date: item.maturity_date,
      }));

      const response = await axios.post(
        "/api/commitment/after_insight",
        { data: dataToSend, number_client: Id },
        {
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": getCookie("csrf_refresh_token"),
          },
        }
      );
    } catch (error) {
      console.log("Error lors du traitement de before inside:", error);
    }
  };

  useEffect(() => {
    if (sendValue) {
      sendValue(handleSendInsight);
    }
  }, [sendValue]);

  const handleFormSubmit = (values) => {
    const parsedValues = {
      matricule: Id,
      line: values["Nature de ligne"], // Remplace "title" par "line"
      account_number: values["Numero compte"],
      authorization: values["Autorisation"], // Remplace "autorisation_amount" par "authorization"
      outstanding_amount: values["En cours"],
      devise: values["Devise"],
      maturity_date: values["Délais de maturité"],
    };

    // Formatage pour l'affichage
    const formattedValues = {
      ...parsedValues,
      authorization: fNumber(values["Autorisation"]) || 0,
      outstanding_amount: fNumber(values["En cours"]) || 0,
    };

    if (editRow) {
      const newData = data.map((line) =>
        line === editRow ? { ...line, ...formattedValues } : line
      );
      setData(newData);
    } else {
      setData([...data, formattedValues]);
    }

    handleModalClose();
  };

  const handleChangeNatureLigne = (e) => {
    setNature(e.target.value);
  };

  const handleChangeNumberCompte = (e) => {
    setCompte(e.target.value);
  };

  const handleChangeAutorisation = (e) => {
    setAutorisation(e.target.value);
  };

  const handleChangeEncour = (e) => {
    setEncour(e.target.value);
  };

  const handleChangeDevise = (e) => {
    setDevise(e.target.value);
  };

  const handleChangeMaturityDate = (e) => {
    setDelais(e.target.value);
  };

  return (
    <Grid container item xs={12} rowSpacing={2} spacing={2}>
      <Grid item xs={12} md={12}>
        <TableContainer component={Paper}>
          <Table
            sx={{ border: "1px solid #9B9B9B", background: `linear-gradient(#EEEEEE, #EEEEEE)` }}
            aria-label="caption table"
          >
            <caption>
              <Button
                onClick={handleModalOpen}
                style={{ background: "#33691e", color: "white" }}
              >
                <AddBoxIcon style={{ color: "white" }} />
              </Button>
            </caption>
            <TableHead>
              <TableRow>
                {data !== undefined
                  ? columnTitle.map((col) => (
                      <TableCell align="center" style={{ fontSize: "12px" }}>
                        <b>{format(col)}</b>
                      </TableCell>
                    ))
                  : null}
                <TableCell align="center" style={{ fontSize: "12px" }}>
                  <b>Action</b>
                </TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {loading ? (
                <Vortex
                  visible={loading}
                  height="80"
                  width="200"
                  ariaLabel="vortex-loading"
                  wrapperStyle={{}}
                  wrapperClass="vortex-wrapper"
                  colors={["red", "green", "blue", "yellow", "orange", "black"]}
                />
              ) : data && data.length > 0 ? (
                data.map((value) => (
                  <TableRow key={value.id}>
                    {columnTitle.map((col) => (
                      <TableCell align="center" style={{ fontSize: "12px" }}>
                        <b style={{ color: value[col] === "devise" ? "#dd2c00" : "#455a64" }}>
                          {value[col]}
                        </b>
                      </TableCell>
                    ))}
                    <TableCell align="center" style={{ fontSize: "12px" }}>
                      <IconButton onClick={() => deleteRow(value)}>
                        <DeleteIcon style={{ color: "red" }} />
                      </IconButton>
                      <IconButton onClick={() => updateRow(value)}>
                        <EditIcon style={{ color: "green" }} />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <Alert variant="filled" severity="error">
                  Aucune information liée au client
                </Alert>
              )}
            </TableBody>
          </Table>
        </TableContainer>
        <Modal
          style={{
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
          }}
          aria-labelledby="transition-modal-title"
          aria-describedby="transition-modal-description"
          open={open}
          onClose={handleModalClose}
          closeAfterTransition
          BackdropComponent={Backdrop}
          BackdropProps={{
            timeout: 500,
          }}
        >
          <Fade in={open}>
            <Grid container item xs={12} style={style}>
              <Grid item xs={12} md={12}>
                <TextField
                  label="Nature de ligne"
                  fullWidth
                  value={nature}
                  onChange={handleChangeNatureLigne}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12}>
                <TextField
                  label="Numero compte"
                  fullWidth
                  value={compte}
                  onChange={handleChangeNumberCompte}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12}>
                <TextField
                  label="Autorisation"
                  fullWidth
                  value={autorisation}
                  onChange={handleChangeAutorisation}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12}>
                <TextField
                  label="En cours"
                  fullWidth
                  value={encour}
                  onChange={handleChangeEncour}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12}>
                <TextField
                  label="Devise"
                  fullWidth
                  value={devise}
                  onChange={handleChangeDevise}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12}>
                <TextField
                  label="Délais de maturité"
                  fullWidth
                  value={delais}
                  onChange={handleChangeMaturityDate}
                  variant="standard"
                />
              </Grid>
              <Grid item xs={12} md={12} style={{ marginTop: "10px" }}>
                <Button
                  onClick={() =>
                    handleFormSubmit({
                      "Nature de ligne": nature,
                      "Numero compte": compte,
                      Autorisation: autorisation,
                      "En cours": encour,
                      Devise: devise,
                      "Délais de maturité": delais,
                    })
                  }
                  fullWidth
                  style={{ background: "#33691e", color: "white" }}
                >
                  Enregistrer
                </Button>
              </Grid>
            </Grid>
          </Fade>
        </Modal>
      </Grid>
    </Grid>
  );
}
